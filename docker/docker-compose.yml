services:
  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: dev
    image: sbs-web:dev
    working_dir: /usr/src/app
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
    env_file:
      - ../.env
    environment:
      - NODE_ENV=development
      - NEXT_TELEMETRY_DISABLED=1
      - CHOKIDAR_USEPOLLING=1
      - WATCHPACK_POLLING=true
      - PORT=${PORT:-3000}
    volumes:
      - ..:/usr/src/app:cached
      - node_modules:/usr/src/app/node_modules
      - ../data:/usr/src/app/data
    command:
      - sh
      - -lc
      - >
        corepack prepare pnpm@latest --activate &&
        node scripts/show-config.js &&
        pnpm exec next dev --hostname 0.0.0.0 -p ${PORT:-3000}
    tty: true

  prod:
    build:
      context: ..
      dockerfile: docker/Dockerfile.prod
      target: prod
      args:
        - NEXTAUTH_URL=${NEXTAUTH_URL}
        - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
        - SPOTIFY_CLIENT_ID=${SPOTIFY_CLIENT_ID}
        - SPOTIFY_CLIENT_SECRET=${SPOTIFY_CLIENT_SECRET}
    image: sbs-web:prod
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
    env_file:
      - ../.env

  # E2E Test Services (profile: test)
  web-test:
    profiles: ["test"]
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: dev
    image: sbs-web:dev
    working_dir: /usr/src/app
    ports:
      - "3100:3100"
    environment:
      - NODE_ENV=development
      - E2E_MODE=1
      - NEXT_TELEMETRY_DISABLED=1
      - CHOKIDAR_USEPOLLING=1
      - WATCHPACK_POLLING=true
      - PORT=3100
      - NEXTAUTH_URL=http://127.0.0.1:3100
      - NEXTAUTH_SECRET=test-secret-key-for-e2e
      - SPOTIFY_CLIENT_ID=dummy-client-id
      - SPOTIFY_CLIENT_SECRET=dummy-client-secret
      - SPOTIFY_BASE_URL=http://spotify-mock:8080
    volumes:
      - ..:/usr/src/app:cached
      - node_modules:/usr/src/app/node_modules
    command:
      - sh
      - -lc
      - >
        corepack prepare pnpm@latest --activate &&
        echo "[E2E Mode] Starting test server on port 3100" &&
        pnpm exec next dev --hostname 0.0.0.0 -p 3100
    depends_on:
      - spotify-mock
    networks:
      - test-network

  spotify-mock:
    profiles: ["test"]
    build:
      context: ..  # Build from root to access docker/mock/server.js
      dockerfile: docker/mock/Dockerfile
    ports:
      - "8081:8080"  # Expose for local debugging
    volumes:
      - ../tests/fixtures:/app/fixtures:ro  # Mount fixtures for instant updates
    networks:
      - test-network

  playwright-runner:
    profiles: ["test"]
    image: mcr.microsoft.com/playwright:v1.48.2-jammy
    working_dir: /work
    environment:
      - BASE_URL=http://web-test:3100
      - CI=true
    volumes:
      - ..:/work:cached
      - playwright-cache:/root/.cache/ms-playwright  # Persist browser downloads
      - node_modules:/work/node_modules  # Use shared node_modules volume
    command: >
      sh -c "
        npm install -g pnpm@10.18.3 &&
        pnpm exec playwright install chromium --with-deps &&
        pnpm exec playwright test
      "
    depends_on:
      - web-test
      - spotify-mock
    networks:
      - test-network

volumes:
  node_modules:
  playwright-cache:  # Persist Playwright browser downloads

networks:
  test-network:
    driver: bridge